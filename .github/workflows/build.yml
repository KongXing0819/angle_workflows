name: Build ANGLE for Android

on:
  workflow_dispatch:  # 手动触发
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-android:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Install depot_tools
      run: |
        git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
        echo "$PWD/depot_tools" >> $GITHUB_PATH
        
    - name: Checkout ANGLE
      run: |
        git clone https://chromium.googlesource.com/angle/angle
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git \
          cmake \
          ninja-build \
          pkg-config \
          libx11-dev \
          libxcomposite-dev \
          libxrandr-dev \
          libxcursor-dev \
          libxi-dev \
          libnss3-dev \
          libatk-bridge2.0-dev
          
    - name: Setup Android SDK and NDK
      uses: android-actions/setup-android@v3
      
    - name: Install Android NDK
      run: |
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "ndk;25.1.8937393"
        
    - name: Bootstrap ANGLE
      run: |
        cd angle
        python scripts/bootstrap.py
        
    - name: Sync ANGLE dependencies
      run: |
        cd angle
        gclient sync
        
    - name: Generate build files
      run: |
        cd angle
        gn gen out/Android-arm64-Release \
          --args=" \
          target_os=\"android\" \
          is_debug=false \
          is_component_build=false \
          is_clang=true \
          use_custom_libcxx=false \
          target_cpu=\"arm64\" \
          android32_ndk_api_level=33 \
          android64_ndk_api_level=33 \
          "
          
    - name: Build ANGLE
      run: |
        cd angle
        ninja -C out/Android-arm64-Release libGLESv2
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: angle-android-arm64-release
        path: angle/out/Android-arm64-Release/**/*.so
        retention-days: 30